<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>台灣 2017 人口遷徙</title>
    <link rel="stylesheet" href="http://cdn.bootcss.com/leaflet/0.7.7/leaflet.css">
    <style>
        html, body, #map {
            height: 100%;
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script src="http://cdn.bootcss.com/leaflet/0.7.7/leaflet.js"></script>
<script src="./src/leaflet-echarts.js"></script>
<script src="./lib/echarts.source.js"></script>
<script src="http://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="./data/country-lat-lng.js"></script>
<script src="./data/export-lat-lng.js"></script>
<script>
  var migration = [];
</script>
<script src="./data/export-migration-1.js"></script>
<script src="./data/export-migration-2.js"></script>
<script src="./data/export-migration-3.js"></script>
<script src="./data/export-migration-4.js"></script>
<script src="./data/export-migration-5.js"></script>
<script src="./data/export-migration-6.js"></script>
<script src="./data/export-migration-7.js"></script>
<script src="./data/export-migration-8.js"></script>
<script src="./data/export-migration-9.js"></script>
<script src="./data/export-migration-10.js"></script>
<script src="./data/export-migration-11.js"></script>
<script src="./data/export-migration-12.js"></script>
<script>
  var map = L.map('map');
  var baseLayers = {
    '高德地圖': L.tileLayer('http://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
      subdomains: "1234"
    }),
    '高德影像': L.layerGroup([L.tileLayer('http://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
      subdomains: "1234"
    }), L.tileLayer('http://t{s}.tianditu.cn/DataServer?T=cta_w&X={x}&Y={y}&L={z}', {
      subdomains: "1234"
    })]),
    'GeoQ灰色底圖': L.tileLayer('http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}').addTo(map)
  };
  L.tileLayer('https://a.tiles.mapbox.com/v3/foursquare.map-0y1jh28j/{z}/{x}/{y}.png', {
    attribution: 'Map &copy; Pacific Rim Coordination Center (PRCC).  Certain data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
    key: 'BC9A493B41014CAABB98F0471D759707',
    styleId: 22677
  });
  var layercontrol = L.control.layers(baseLayers, {
    position: "topleft"
  }).addTo(map);
  map.setView(L.latLng(23.6653535, 120.9343868), 8);
  var overlay = new L.echartsLayer(map, echarts);
  var chartsContainer=overlay.getEchartsContainer();
  var myChart=overlay.initECharts(chartsContainer);
  window.onresize = myChart.onresize;
  var option = {
    title: {
      text: '台灣 2017 人口遷徙Leaflet版',
      subtext: '- By KJ',
      x:'center',
      y:'bottom',
      textStyle: {
        color: '#FFC107'
      }
    },
    legend: {
      show: true,
      x: 'left',
      y:'bottom',
      orient: 'vertical',
      textStyle: {
        color: 'red'
      },
      data: [
        '2017/1-3',
        '2017/4-6',
        '2017/7-9',
        '2017/10-12',
        '六都'
      ]
    },
    series: [
      {
        name: '2017/1-3',
        type: 'map',
        mapType: 'none',
        itemStyle: {
          normal: {
            borderColor:'rgba(100,149,237,0.2)',
            borderWidth:0.5,
            areaStyle: {
              color: '#1b1b1b'
            }
          }
        },
        data: [{}],
        hoverable: false,
        clickable: false,
        roam: true,
        markLine: {
          effect: {
            color: 'rgba(204, 246, 255, 0.09)',
            show: true,
            period: 40
          },
          bundling: {
            enable: true
          },
          large: true,
          smooth: true,
          smoothness: 0.1,
          symbol: ['none', 'none'],
          itemStyle: {
            normal: {
              lineStyle: {
                color: 'rgba(2, 166, 253, 0.05)',
                type: 'solid',
                width: 0.5,
                opacity: 0.2
              }
            }
          },
          data: []
        },
        markPoint: {
          symbol: 'pin',
          symbolSize: 3,
          itemStyle: {
            normal: {
              color: 'rgba(255, 0, 0, 0.8)'
            }
          },
          data: []
        }
      },
      {
        name: '2017/4-6',
        type: 'map',
        mapType: 'none',
        itemStyle: {
          normal: {
            borderColor:'rgba(100,149,237,0.2)',
            borderWidth:0.5,
            areaStyle: {
              color: '#1b1b1b'
            }
          }
        },
        data: [{}],
        hoverable: false,
        clickable: false,
        roam: true,
        markLine: {
          effect: {
            color: 'rgba(204, 246, 255, 0.09)',
            show: true,
            period: 40
          },
          bundling: {
            enable: true
          },
          large: true,
          smooth: true,
          smoothness: 0.1,
          symbol: ['none', 'none'],
          itemStyle: {
            normal: {
              lineStyle: {
                color: 'rgba(253, 166, 2, 0.05)',
                type: 'solid',
                width: 0.5,
                opacity: 0.2
              }
            }
          },
          data: []
        },
        markPoint: {
          symbol: 'pin',
          symbolSize: 3,
          itemStyle: {
            normal: {
              color: 'rgba(255, 0, 0, 0.8)'
            }
          },
          data: []
        }
      },
      {
        name: '2017/7-9',
        type: 'map',
        mapType: 'none',
        itemStyle: {
          normal: {
            borderColor:'rgba(100,149,237,0.2)',
            borderWidth:0.5,
            areaStyle: {
              color: '#1b1b1b'
            }
          }
        },
        data: [{}],
        hoverable: false,
        clickable: false,
        roam: true,
        markLine: {
          effect: {
            color: 'rgba(204, 246, 255, 0.09)',
            show: true,
            period: 40
          },
          bundling: {
            enable: true
          },
          large: true,
          smooth: true,
          smoothness: 0.1,
          symbol: ['none', 'none'],
          itemStyle: {
            normal: {
              lineStyle: {
                color: 'rgba(166, 253, 253, 0.05)',
                type: 'solid',
                width: 0.5,
                opacity: 0.2
              }
            }
          },
          data: []
        },
        markPoint: {
          symbol: 'pin',
          symbolSize: 3,
          itemStyle: {
            normal: {
              color: 'rgba(255, 0, 0, 0.8)'
            }
          },
          data: []
        }
      },
      {
        name: '2017/10-12',
        type: 'map',
        mapType: 'none',
        itemStyle: {
          normal: {
            borderColor:'rgba(100,149,237,0.2)',
            borderWidth:0.5,
            areaStyle: {
              color: '#1b1b1b'
            }
          }
        },
        data: [{}],
        hoverable: false,
        clickable: false,
        roam: true,
        markLine: {
          effect: {
            color: 'rgba(204, 246, 255, 0.09)',
            show: true,
            period: 40
          },
          bundling: {
            enable: true
          },
          large: true,
          smooth: true,
          smoothness: 0.1,
          symbol: ['none', 'none'],
          itemStyle: {
            normal: {
              lineStyle: {
                color: 'rgba(2, 253, 166, 0.05)',
                type: 'solid',
                width: 0.5,
                opacity: 0.2
              }
            }
          },
          data: []
        },
        markPoint: {
          symbol: 'pin',
          symbolSize: 3,
          itemStyle: {
            normal: {
              color: 'rgba(255, 0, 0, 0.8)'
            }
          },
          data: []
        }
      },
      {
        name: '六都',
        type: 'map',
        mapType: 'none',
        itemStyle: {
          normal: {
            borderColor:'rgba(100,149,237,0.2)',
            borderWidth:0.5,
            areaStyle: {
              color: '#1b1b1b'
            }
          }
        },
        data: [{}],
        markPoint: {
          symbol: 'pin',
          symbolSize: 5,
          itemStyle: {
            normal: {
              color: 'rgba(255, 255, 255, 0.8)'
            }
          },
          data: []
        }
      },
    ]
  };
  areaLatLng = areaLatLng[0];
  function getCountryGeoCoord (name) {
    var city = country[name];
    return [city.lng, city.lat];
  }
  function getAreaGeoCoord (name) {
    return [parseFloat(areaLatLng[name].lng), parseFloat(areaLatLng[name].lat)];
  }
  var lines = [];
  var areaOutHot = [];
  var count = 0;
  for (index in migration) {
    month = migration[index][0];
    for (areaName in month) {
      var start = getAreaGeoCoord(areaName);
      for (countryName in month[areaName]) {
        var outTotal = month[areaName][countryName].male + month[areaName][countryName].female;
        if (!areaOutHot[areaName]) {
          areaOutHot[areaName] = 0;
        }
        areaOutHot[areaName] += outTotal;
        if (outTotal > 0) {
          var end = getCountryGeoCoord(countryName);
          lines.push({
            start: start,
            end: end,
          });
        }
      }
    }
    if (0 == (index + 1) % 3) {
      option.series[count].markLine.data = lines.map(function (line) {
        return [{
            geoCoord: line.start
        }, {
            geoCoord: line.end
        }];
      });

      var getOnePoint = [];
      for (areaName in areaOutHot) {
        console.log(areaName + ':' + areaOutHot[areaName]);
        if (areaOutHot[areaName] > 1500) {
          getOnePoint.push({geoCoord: getAreaGeoCoord(areaName)});
        }
      }
      option.series[count].markPoint.data = getOnePoint;
      areaOutHot = [];
      count++;
      lines = [];
    }
  }

  var countrys = [];
  for (countryName in country) {
    countrys.push({
      geoCoord: [country[countryName].lng, country[countryName].lat]
    });
  }
  option.series[count].markPoint.data = countrys;
  overlay.setOption(option);
</script>
</body>
</html>